generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id         String    @id @default(cuid())
  name            String
  email           String    @unique
  passwordHash    String
  role            Role
  department      String?
  regNumber       String?
  program         String?
  status          UserStatus @default(PENDING_PASSWORD_CHANGE)
  onboardingCompleted Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  assessor        Assessor? 
  student         Student?
  otp             String?
  otpExpires      DateTime?
  otpSentAt       DateTime?
}

model Assessor {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [user_id])
  courseAssignments CourseAssignment[]
  moduleAssignments   ModuleAssignment[]
  enrollments         Enrollment[]
  observations        Observation[]
  announcements     Announcement[]
}

model Student {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [user_id])
  walletSettings  Json?
  enrollments     Enrollment[]
  submissions     Submission[]
  observations    Observation[]
  microCredentials MicroCredential[]
  courseCredentials CourseCredential[]
}

model Course {
  course_id         String    @id @default(cuid())
  name              String
  code              String    @unique
  category          String?
  description       String?
  createdBy         String
  approved          Boolean   @default(false)
  minDescriptor     String?
  weighting         Json?
  credentialModuleIds String[]
  createdAt         DateTime  @default(now())
  modules           Module[]
  courseAssignments CourseAssignment[]
  courseCredentials CourseCredential[]
}

model Module {
  module_id         String    @id @default(cuid())
  course_id         String
  course            Course    @relation(fields: [course_id], references: [course_id])
  moduleCode        String
  title             String
  description       String?
  version           Int       @default(1)
  status            ModuleStatus @default(DRAFT)
  createdBy         String
  createdAt         DateTime  @default(now())
  assessments       Assessment[]
  enrollments       Enrollment[]
  moduleAssignments ModuleAssignment[]
  observations      Observation[]
  microCredentials  MicroCredential[]
  announcements     Announcement[]

  @@unique([course_id, moduleCode])
}

model CourseAssignment {
  id          String    @id @default(cuid())
  courseId    String
  course      Course    @relation(fields: [courseId], references: [course_id])
  assessorId  String
  assessor    Assessor  @relation(fields: [assessorId], references: [id])
  role        CourseRole @default(GRADER)
  assignedAt  DateTime  @default(now())

  @@unique([courseId, assessorId])
}

model ModuleAssignment {
  id          String    @id @default(cuid())
  moduleId    String
  module      Module    @relation(fields: [moduleId], references: [module_id])
  assessorId  String
  assessor    Assessor  @relation(fields: [assessorId], references: [id])
  role        ModuleRole @default(GRADER)
  assignedAt  DateTime  @default(now())

  @@unique([moduleId, assessorId])
}

model Assessment {
  assessment_id   String        @id @default(cuid())
  module_id       String
  module          Module        @relation(fields: [module_id], references: [module_id])
  title           String
  submissionTypes String[]
  group           AssessmentGroup
  rubric          Json
  maxAttempts     Int?
  deadline        DateTime?
  availableFrom   DateTime?
  createdAt       DateTime      @default(now())
  submissions     Submission[]
}

model Enrollment {
  id          String    @id @default(cuid())
  module_id   String
  module      Module    @relation(fields: [module_id], references: [module_id])
  assessor_id String
  assessor    Assessor  @relation(fields: [assessor_id], references: [id])
  student_id  String
  student     Student   @relation(fields: [student_id], references: [id])
  enrolledAt  DateTime  @default(now())

  @@unique([module_id, student_id])
}

model Submission {
  submission_id String      @id @default(cuid())
  assessment_id String
  assessment    Assessment  @relation(fields: [assessment_id], references: [assessment_id])
  student_id    String
  student       Student     @relation(fields: [student_id], references: [id])
  data          Json
  grade         Json?
  attempts      Int         @default(1)
  createdAt     DateTime    @default(now())
  gradedAt      DateTime?
}

model Observation {
  id             String    @id @default(cuid())
  module_id      String
  module         Module    @relation(fields: [module_id], references: [module_id])
  assessor_id    String
  assessor       Assessor  @relation(fields: [assessor_id], references: [id])
  student_id     String
  student        Student   @relation(fields: [student_id], references: [id])
  competencyTags String[]
  numericScore   Int?
  descriptor     String?
  notes          String?
  media          Json?
  recordedAt     DateTime  @default(now())
}

model MicroCredential {
  id            String    @id @default(cuid())
  student_id    String
  student       Student   @relation(fields: [student_id], references: [id])
  module_id     String
  module        Module    @relation(fields: [module_id], references: [module_id])
  descriptor    String
  score         Int?
  issuedAt      DateTime?
  txHash        String?
  status        CredentialStatus @default(PENDING)
  payloadJson   Json
  type          CredentialType @default(MICRO_CREDENTIAL)
}

model CourseCredential {
  id            String    @id @default(cuid())
  student_id    String
  student       Student   @relation(fields: [student_id], references: [id])
  course_id     String
  course        Course    @relation(fields: [course_id], references: [course_id])
  descriptor    String
  evidenceModuleIds String[]
  evidenceMicroCredentialIds String[]
  issuedAt      DateTime?
  txHash        String?
  status        CredentialStatus @default(PENDING)
  payloadJson   Json
}

model Audit {
  id        String    @id @default(cuid())
  who       String
  action    String
  entity    String
  entityId  String
  before    Json?
  after     Json?
  createdAt DateTime  @default(now())
}

model Announcement {
  id        String    @id @default(cuid())
  title     String
  content   String
  moduleId  String
  module    Module    @relation(fields: [moduleId], references: [module_id])
  assessorId String
  assessor  Assessor @relation(fields: [assessorId], references: [id])
  createdAt DateTime  @default(now())
}

enum Role {
  ADMIN
  ASSESSOR
  STUDENT
}

enum UserStatus {
  ACTIVE
  PENDING_PASSWORD_CHANGE
}

enum AssessmentGroup {
  FORMATIVE
  SUMMATIVE
}

enum CredentialStatus {
  PENDING
  ISSUED
  REVOKED
}

enum CredentialType {
  MICRO_CREDENTIAL
  STATEMENT_OF_ATTAINMENT
}

enum ModuleStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

enum CourseRole {
  LEAD
  GRADER
}

enum ModuleRole {
  OWNER
  GRADER
}